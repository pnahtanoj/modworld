<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="drum-machine">
  <template>
    <style include="iron-flex iron-flex-alignment"></style>
    <style>
      :host {
        display: block;
        background-color: #E6E6E6;
        padding: 1em;

      }
      #title {
        @apply(--layout-flex-10);
      }
      #songs {

      }
      #controls {
        @apply(--layout-flex-2);
        @apply(--layout-horizontal-reverse);
        @apply(--layout-center);
        /*background-color: red;*/
      }

    </style>
    
    <div class="layout horizontal center">
      <h1 id='title'>Drum Machine</h1>

      <paper-dropdown-menu label="Clock Options">
        <paper-menu class="dropdown-content" selected="{{clockSetting}}">
          <template is='dom-repeat' items="{{clock.availableRates}}">
            <paper-item>{{item}}</paper-item>
          </template>
        </paper-menu>
      </paper-dropdown-menu>

      <paper-dropdown-menu label='Select Song'>          
      </paper-dropdown-menu>
      
      <div id='controls'>
        <paper-icon-button id='reset' icon="refresh" on-tap='reset'>Reset Song</paper-icon-button>
      </div>
    </div>

    <div class="layout">
      <sequencer-track id='kick' title='Kick' sibling-soloed='{{_trackIsSoloed}}'></sequencer-track>
      <sequencer-track id='snare' title='Snare' sibling-soloed='{{_trackIsSoloed}}'></sequencer-track>
      <sequencer-track id='hat' title='Hat' sibling-soloed='{{_trackIsSoloed}}'></sequencer-track>
      <sequencer-track id='tom' title='Tom' sibling-soloed='{{_trackIsSoloed}}'></sequencer-track>
    </div>

    ME: {{clockSetting}}

  </template>
  <script>
  (function() {
    'use strict';

    Polymer({
      is: 'drum-machine',
      _isPlaying: false,
      _trackIsSoloed: Boolean,

      properties: {
        clock: {
          type: Object,
          notify: true
        },
        context: {
          type: Object,
          notify: true
        },
        clockSetting: {
          type: String,
          observer: 'updateClockSelection'
        },
        currentStep: {
          type: Number,
          value: 1
        },
        maxSteps: {
          type: Number,
          value: 16
        }
      },
      listeners: {
        'soloChange': 'updateSolos'
      },
      observers: [
        'contextReady(context.ready)'
      ],
      ready: function() {
        this._trackIsSoloed = false;
      },
      play: function() {
        this._isPlaying = true;
        this.futureTickTime = this.$.audioContext.getCurrentTime();

        this._playLoop();
      },
      stop: function() {
        this._isPlaying = false;
        this.currentStep = 1;
      },
      reset: function() {
          let tracks = this.getTracks();
          for (var i = 0; i < tracks.length; i++) {
            tracks[i].reset();
          }
      },
      updateSolos: function(event) {
        this._trackIsSoloed = false;

        let tracks = this.getTracks();
        for (var i = 0; i < tracks.length; i++) {
          if (tracks[i].solo) {
            this._trackIsSoloed = true;
          }
        }
      },
      updateClockSelection: function() {
        var myId = `${this.id}:drum-machine:master`,
            input = new Input(myId,this.moveForward.bind(this));
        this.clock.connect(this.clock.availableRates[this.clockSetting], input);
      },
      contextReady: function(context) {
        // PRELOADING SAMPLES TOO //
        var kickSequence = 
          new Sequence()
            .setLength(16)
            .setStep(2,1)
            .setStep(3,2)
            .setStep(6,3)
            .setStep(7,2)
            .setStep(9,1)
            .setStep(12,2)
            .setStep(14,1)
            .setStep(15,3);

        var snareSequence = 
          new Sequence()
            .setLength(16)
            .setStep(5,3)
            .setStep(13,3);

        var hatSequence = 
          new Sequence()
            .setLength(16)
            .setStep(1,3)
            .setStep(2,1)
            .setStep(3,2)
            .setStep(4,1)
            .setStep(6,1)
            .setStep(7,1)
            .setStep(8,2)
            .setStep(10,1)
            .setStep(11,3)
            .setStep(12,1);

        this.$.kick
          .setContext(this.context)
          .loadSound('samples/E-Mu-Proteus-FX-909-Kick.wav')
          .loadSequence(kickSequence);

        this.$.snare
          .setContext(this.context)
          .loadSound('samples/Hip-Hop-Snare-1.wav')
          .loadSequence(snareSequence);

        this.$.hat
          .setContext(this.context)
          .loadSound('samples/Closed-Hi-Hat-1.wav')
          .loadSequence(hatSequence);

        this.$.tom
          .setContext(this.context)
          .loadSound('samples/Electro-Tom.wav')
          .loadSequence(new Sequence().setLength(16));
      },
      moveForward: function(time) {
          // console.log('DRM move: ', this.id, time);
          let tracks = this.getTracks();
          for (var i = 0; i < tracks.length; i++) {
            tracks[i].playNextStep(time);
          }
          
          this.currentStep++;
          if (this.currentStep > this.maxSteps)
            this.currentStep = 1;
      },
      getTracks: function() {
        return Polymer.dom(this.root).querySelectorAll('sequencer-track');
      }
    });
  })();
  </script>
</dom-module>
