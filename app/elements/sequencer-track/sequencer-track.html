<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="sequencer-track">
  <template>
    <style include="iron-flex iron-flex-alignment">
    <style>
      :host {
        display: block;
      }
      #container {
        @apply(--layout-horizontal);
        @apply(--layout-center);
        background-color: #FFFFFF;
        padding: 0.4em;
        margin: 1em;
      }
      #title {
        font-size: 1.4em;
        @apply(--layout-flex-2);
        /*background-color: red;*/
      }
      #steps {
        @apply(--layout-flex-10);
        @apply(--layout-horizontal);
        @apply(--layout-center);
        /*background-color: blue;*/
      }
      #controls {
        @apply(--layout-flex-2);
        /*background-color: green;*/
        @apply(--layout-horizontal);
        @apply(--layout-center);
      }
      .bypassed {
        opacity: 0.4;
        /*background-color: red !important;*/
      }

    </style>
    <div id="container" class$="{{_bypassClass}}">

      <div id='title'>{{title}}</div>

      <div id='steps'>
        <template is='dom-repeat' items="{{steps}}">
          <sequencer-track-step state='{{item.value}}'></sequencer-track-step>
        </template>
      </div>

      <div id='controls'>
        <paper-slider min='0' max='100' value='{{_volume}}'></paper-slider>
        <mute-button mute={{mute}}></mute-button>
        <solo-button solo={{solo}}></solo-button>
        <paper-icon-button id='preview' icon="refresh" on-tap='reset'></paper-icon-button>
        <paper-icon-button id='preview' icon="arrow-forward" on-tap='preview'></paper-icon-button>
        <paper-icon-button id='preview' icon="check-box-outline-blank" on-tap='preview'></paper-icon-button>
      </div>

    </div>

  </template>
  <script>
  (function() {
    'use strict';

    var context;

    Polymer({
      is: 'sequencer-track',
      _reset: Boolean,
      _step: Number, // ZERO BASED //
      _volume: Number,
      mute: Boolean,
      _bypassClass: String,

      properties: {
        solo: {
          type: Boolean,
          value: false,
          reflectToAttribute: true,        
          notify: true,
          observer: 'updateSolo'
        },
        siblingSoloed: {
          type: Boolean,
          value: false,
          observer: 'updateBypass'
        },
        sound: {
          type: Object
        },
        context: {
          type: Object
        },
        steps: {
          type: Array,
          value: function() { return [
            {'value': 0},
            {'value': 1},
            {'value': 0},
            {'value': 3},
            {'value': 0},
            {'value': 0},
            {'value': 0},
            {'value': 0},
            {'value': 0},
            {'value': 0},
            {'value': 0},
            {'value': 0},
            {'value': 0},
            {'value': 0},
            {'value': 0},
            {'value': 0}];
          },
          notify: true
        }
      },

      ready: function() {
        this._reset = false;
        this._step = 0;
        this._volume = 80;
        this.mute = false;
        this._bypassClass = false;
      },
      setContext: function(context) {
        this.context = context;
        return this;
      },
      updateSolo: function() {
        this.fire('soloChange', {solo: this.solo, track: this.id});
      },
      updateBypass: function() {
        this._bypassClass = (this.siblingSoloed && !this.solo) ? 'bypassed' : '';
      },
      loadSequence: function(sequence) {
        this.steps = sequence;
        return this;
      },
      loadSound: function(soundFile) {
        this.sound = this.context.getSoundFile();
        this.sound.loadSound(soundFile);
        return this;
      },
      preview: function() {
        this.playSound(null, this.getVolume());
      },
      getVolume: function() {
        return (this._volume / 100);
      },
      getStepVolume: function() {
        return this.getVolume() * this.getStepReductionFactor();
      },
      getStepReductionFactor: function() {
        var value = 0.6; // 1
        value += (this.steps[this._step].value - 1) * 0.2;

        return value;
      },
      playSound: function(time, volume) {
        this.sound.volume = volume;
        this.sound.play(time);
      },
      playNextStep(time) {
        if (this._reset) {
          this._step = 1;
          this._reset = false;
        }
        if ((this.steps[this._step].value > 0 && !this.mute) && (!this.siblingSoloed || this.solo)) {
          this.playSound(time, this.getStepVolume());
        }
        this.activateStep();

        this.increment();
      },
      increment: function() {
        this._step += 1;
        if (this._step >= 16)
          this._step = 0;
      },
      reset: function() {
        this._reset = true;
      },
      activateStep: function() {
        var steps = Polymer.dom(this.root).querySelectorAll('sequencer-track-step');

        for(var i = 0; i < this.steps.length; i++) {
          if (i == this._step)
            steps[i].setActive(true);
          else
            steps[i].setActive(false);
        }
      }
    });
  })();
  </script>
</dom-module>
